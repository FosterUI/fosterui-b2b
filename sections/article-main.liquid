{% comment %} {{ 'section-blog-post.css' | asset_url | stylesheet_tag }} {% endcomment %}
{{ 'section-blog-layout.css' | asset_url | stylesheet_tag }}

<article class="article-wrapper-section">
  <div class="article-container {{ section.settings.custom_css }}">
    <div class="article-content-block page-width">
      {% comment %} --- PILLAR CALLOUT --- {% endcomment %}
      {% if section.settings.pillar_link_title != blank and section.settings.pillar_link_url != blank %}
        <div class="pillar-link-callout">
          <p>
            {{ section.settings.pillar_link_text }}
            <a href="{{ section.settings.pillar_link_url }}">{{ section.settings.pillar_link_title }}</a>
          </p>
        </div>
      {% endif %}

      {% comment %} --- AUDIO PLAYER --- {% endcomment %}
      {% assign audio_file = article.metafields.custom.audio_overview.value %}
      {% if audio_file %}
        <div class="article-audio-player">
          <label class="article-audio-player__label" for="audio-player-{{ article.id }}">
            {{- section.settings.audio_player_label -}}
          </label>

          {% comment %} Try different approaches to get a working audio URL {% endcomment %}
          {% assign audio_url_method1 = audio_file | file_url %}
          {% assign audio_url_method2 = audio_file.url %}
          {% assign audio_url_method3 = audio_file | image_url %}

          {% comment %} Use the first available URL method {% endcomment %}
          {% if audio_url_method2 != blank %}
            {% assign audio_url = audio_url_method2 %}
          {% elsif audio_url_method1 != blank %}
            {% assign audio_url = audio_url_method1 %}
          {% else %}
            {% assign audio_url = audio_url_method3 %}
          {% endif %}

          {% comment %} Ensure HTTPS protocol {% endcomment %}
          {% if audio_url contains '//' and audio_url contains 'fosterui.com' %}
            {% assign audio_url = 'https:' | append: audio_url %}
          {% endif %}

          {% comment %} Render audio player with comprehensive format support {% endcomment %}
          <audio id="audio-player-{{ article.id }}" controls preload="metadata" crossorigin="anonymous">
            <source src="{{ audio_url }}" type="audio/m4a">
            <source src="{{ audio_url }}" type="audio/x-m4a">
            <source src="{{ audio_url }}" type="audio/mp4">
            <source src="{{ audio_url }}" type="audio/mpeg">
            <source src="{{ audio_url }}" type="audio/wav">
            Your browser does not support the audio element.
          </audio>

          {% comment %} Enhanced JavaScript error handling and debugging {% endcomment %}
          <script>
            document.addEventListener('DOMContentLoaded', function () {
              const audio = document.getElementById('audio-player-{{ article.id }}');
              if (!audio) {
                console.error('Audio element not found!');
                return;
              }
              const audioContainer = audio.closest('.article-audio-player');
              let errorShown = false;

              // Function to show error message
              function showError(message) {
                if (!errorShown) {
                  errorShown = true;
                  const errorDiv = document.createElement('div');
                  errorDiv.style.cssText =
                    'padding: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; margin-top: 1rem;';
                  errorDiv.innerHTML =
                    '<strong>Audio Error:</strong> ' +
                    message +
                    '<br><small>Please try re-uploading the audio file or contact support.</small>';
                  audioContainer.appendChild(errorDiv);
                }
              }

              // Handle various audio events
              audio.addEventListener('error', function (e) {
                console.error('Audio error event:', e);
                showError('The audio file could not be loaded.');
              });

              let audioLoaded = false;

              audio.addEventListener('loadstart', function () {
                console.log('Audio loading started for URL:', audio.currentSrc || '{{ audio_url }}');
              });

              audio.addEventListener('loadeddata', function () {
                audioLoaded = true;
                console.log('Audio data loaded successfully');
              });

              audio.addEventListener('canplay', function () {
                audioLoaded = true;
                console.log('Audio ready to play');
              });

              // Only show error if audio truly fails to load
              setTimeout(function () {
                if (audio.readyState === 0 && !audioLoaded) {
                  console.error('Audio failed to load after timeout');
                  showError('Audio file is not accessible at the current URL.');
                }
              }, 8000);
            });
          </script>
        </div>
      {% endif %}
    </div>
    {% comment %} --- MAIN ARTICLE CONTENT --- {% endcomment %}
    <div class="article-content-block page-width rte">
      {{ article.content }}
    </div>

    {% comment %} --- AUTHOR BIO --- {% endcomment %}
    {% if section.settings.author_cta_title != blank %}
      <div class="article-content-block page-width">
        <div class="article-author-cta">
          {% if section.settings.author_cta_headshot != blank %}
            <div class="article-author-cta__image">
              <img
                src="{{ section.settings.author_cta_headshot | image_url: width: 100, height: 100 }}"
                alt="{{ article.author }}"
                class="author-cta__headshot"
                width="100"
                height="100"
                loading="lazy"
              >
            </div>
          {% endif %}
          <div class="article-author-cta__content">
            <div class="article-author-cta__bio">
              <h3>{{ section.settings.author_cta_title }}</h3>
              <p>{{ section.settings.author_cta_text }}</p>
            </div>
            {% if section.settings.author_cta_button_label != blank
              and section.settings.author_cta_button_link != blank
            %}
              <div class="article-author-cta__action">
                <a href="{{ section.settings.author_cta_button_link }}" class="btn-brand btn-brand-primary">
                  {{ section.settings.author_cta_button_label }}
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}

    {% comment %} --- REFERENCES --- {% endcomment %}
    {%- if article.metafields.custom.article_references != blank -%}
      <div class="article-content-block references-section">
        <h2 class="h3 rich-text__heading article-content-heading">References</h2>
        <div class="rte">
          {{ article.metafields.custom.article_references | metafield_tag }}
        </div>
      </div>
    {%- endif -%}
  </div>
</article>

{% schema %}
{
  "name": "B2B Article Main",
  "settings": [
    {
      "type": "text",
      "id": "custom_css",
      "label": "Custom CSS Classes"
    },
    {
      "type": "header",
      "content": "Pillar Link Callout"
    },
    {
      "type": "text",
      "id": "pillar_link_text",
      "label": "Intro Text",
      "default": "This article is part of my comprehensive resource:"
    },
    {
      "type": "text",
      "id": "pillar_link_title",
      "label": "Pillar Page Title",
      "default": "The Definitive Guide to AI-Powered B2B on Shopify Plus."
    },
    {
      "type": "url",
      "id": "pillar_link_url",
      "label": "Pillar Page URL"
    },
    {
      "type": "header",
      "content": "Audio Player"
    },
    {
      "type": "paragraph",
      "content": "The audio player automatically appears if the 'Article Audio Overview' metafield (custom.audio_overview) is populated on the blog post."
    },
    {
      "type": "text",
      "id": "audio_player_label",
      "label": "Audio Player Label",
      "default": "Listen to the Audio Overview:"
    },
    {
      "type": "header",
      "content": "Author Bio & CTA"
    },
    {
      "type": "image_picker",
      "id": "author_cta_headshot",
      "label": "Author Headshot (Bio)"
    },
    {
      "type": "text",
      "id": "author_cta_title",
      "label": "Title",
      "default": "About the Author & Expert"
    },
    {
      "type": "textarea",
      "id": "author_cta_text",
      "label": "Bio/Pitch Text",
      "default": "With over a decade of specialized experience deep within the Shopify ecosystem, I am a principal consultant focused exclusively on transforming DTC stores into AI-powered B2B wholesale engines. My methodology leverages this deep expertise to deliver specialized revenue acceleration, velocity, and precision."
    },
    {
      "type": "text",
      "id": "author_cta_button_label",
      "label": "Button Label",
      "default": "Book My $1,950 Roadmap"
    },
    {
      "type": "url",
      "id": "author_cta_button_link",
      "label": "Button Link"
    }
  ],
  "presets": [
    {
      "name": "B2B Article Main"
    }
  ]
}
{% endschema %}
