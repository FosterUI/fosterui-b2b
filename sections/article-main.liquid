{{ 'section-blog-layout.css' | asset_url | stylesheet_tag }}

<article class="article-wrapper">
  <div class="article-container">
    
    {% comment %} Strategic Addition: Pillar Link Callout {% endcomment %}
    {% if section.settings.enable_pillar_link %}
        <div class="pillar-link-callout">
            <p>
                {{ section.settings.pillar_link_text }}
                <a href="{{ section.settings.pillar_link_url }}">{{ section.settings.pillar_link_title }}</a>
            </p>
        </div>
    {% endif %}

    {% comment %} NEW: Article Audio Overview Player {% endcomment %}
    {% comment %} Check if the metafield 'custom.audio_overview' has a value and assign the file object {% endcomment %}
    {% assign audio_file = article.metafields.custom.audio_overview.value %}
    
    {% if audio_file %}
      <div class="article-audio-player">
        <label class="article-audio-player__label" for="audio-player-{{ article.id }}">{{ section.settings.audio_player_label }}</label>
        
        {% comment %} Get the URL of the file using file_url filter and ensure it has https protocol {% endcomment %}
        {% assign audio_url_raw = audio_file | file_url %}
        {% if audio_url_raw contains '//' and audio_url_raw contains 'fosterui.com' %}
          {% assign audio_url = 'https:' | append: audio_url_raw %}
        {% else %}
          {% assign audio_url = audio_url_raw %}
        {% endif %}
        
        {% comment %} Render the native HTML5 audio player with error handling {% endcomment %}
        <audio id="audio-player-{{ article.id }}" controls preload="metadata">
          {% comment %} Try multiple MIME types for better compatibility {% endcomment %}
          <source src="{{ audio_url }}" type="audio/m4a">
          <source src="{{ audio_url }}" type="audio/x-m4a">
          <source src="{{ audio_url }}" type="audio/mp4">
          <source src="{{ audio_url }}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
        
        {% comment %} JavaScript to handle audio loading errors {% endcomment %}
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const audio = document.getElementById('audio-player-{{ article.id }}');
            const audioContainer = audio.closest('.article-audio-player');
            
            audio.addEventListener('error', function(e) {
              console.error('Audio loading error:', e);
              audioContainer.innerHTML = '<div style="padding: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;"><strong>Audio Error:</strong> The audio file could not be loaded. Please check if the file was uploaded correctly to the metafield.</div>';
            });
            
            audio.addEventListener('loadstart', function() {
              console.log('Audio loading started for URL:', audio.currentSrc || '{{ audio_url }}');
            });
            
            audio.addEventListener('canplay', function() {
              console.log('Audio can play - file loaded successfully');
            });
          });
        </script>
        
        {% comment %} Debug information - remove this after testing {% endcomment %}
        <div style="margin-top: 1rem; padding: 1rem; background: #f0f0f0; font-size: 1.2rem; font-family: monospace;">
          <strong>Debug Info:</strong><br>
          Audio URL: {{ audio_url }}<br>
          File object: {{ audio_file }}<br>
          {% if audio_file.content_type %}
            Content Type: {{ audio_file.content_type }}<br>
          {% endif %}
          {% if audio_file.size %}
            File Size: {{ audio_file.size }} bytes<br>
          {% endif %}
        </div>
      </div>
    {% endif %}


    {% comment %} Main Article Content {% endcomment %}
    <div class="article-content rte">
      {{ article.content }}
    </div>

    {% comment %} Author Bio / CTA (Updated Layout) {% endcomment %}
    {% if section.settings.enable_author_cta %}
        <div class="article-author-cta">
            
            {% if section.settings.author_cta_headshot != blank %}
                <div class="article-author-cta__image">
                    <img src="{{ section.settings.author_cta_headshot | image_url: width: 100, height: 100 }}" alt="{{ article.author }}" class="author-cta__headshot" width="100" height="100" loading="lazy">
                </div>
            {% endif %}

            <div class="article-author-cta__content">
                <div class="article-author-cta__bio">
                    <h3>{{ section.settings.author_cta_title }}</h3>
                    <p>{{ section.settings.author_cta_text }}</p>
                </div>
                <div class="article-author-cta__action">
                    <a href="{{ section.settings.author_cta_button_link }}" class="btn-brand btn-brand-primary">
                        {{ section.settings.author_cta_button_label }}
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

  </div>
</article>

{% schema %}
{
  "name": "B2B Article Main Content",
  "settings": [
    {
        "type": "header",
        "content": "Audio Player"
    },
    {
        "type": "paragraph",
        "content": "The audio player automatically appears if the 'Article Audio Overview' metafield (custom.audio_overview) is populated on the blog post."
    },
    {
        "type": "text",
        "id": "audio_player_label",
        "label": "Audio Player Label",
        "default": "Listen to the Audio Overview:"
    },
    {
        "type": "header",
        "content": "Pillar Link Callout (Hub/Spoke)"
    },
    {
        "type": "paragraph",
        "content": "Crucial for SEO: Link back to your main Pillar Page."
    },
    {
        "type": "checkbox",
        "id": "enable_pillar_link",
        "label": "Enable Pillar Link Callout",
        "default": true
    },
    {
        "type": "text",
        "id": "pillar_link_text",
        "label": "Intro Text",
        "default": "This article is part of my comprehensive resource:"
    },
    {
        "type": "text",
        "id": "pillar_link_title",
        "label": "Pillar Page Title",
        "default": "The Definitive Guide to AI-Powered B2B on Shopify Plus."
    },
    {
        "type": "url",
        "id": "pillar_link_url",
        "label": "Pillar Page URL"
    },
    {
        "type": "header",
        "content": "Author Bio / Final CTA"
    },
    {
        "type": "checkbox",
        "id": "enable_author_cta",
        "label": "Enable Author CTA Box",
        "default": true
    },
    {
      "type": "image_picker",
      "id": "author_cta_headshot",
      "label": "Author Headshot (Bio)"
    },
    {
        "type": "text",
        "id": "author_cta_title",
        "label": "Title",
        "default": "About the Author & Expert"
    },
    {
        "type": "textarea",
        "id": "author_cta_text",
        "label": "Bio/Pitch Text",
        "default": "With over a decade of specialized experience deep within the Shopify ecosystem, I am a principal consultant focused exclusively on transforming DTC stores into AI-powered B2B wholesale engines. My methodology leverages this deep expertise to deliver specialized revenue acceleration, velocity, and precision."
    },
    {
        "type": "text",
        "id": "author_cta_button_label",
        "label": "Button Label",
        "default": "Book My $1,950 Roadmap"
    },
    {
        "type": "url",
        "id": "author_cta_button_link",
        "label": "Button Link"
    }
  ],
  "presets": [
    {
      "name": "B2B Article Main Content"
    }
  ]
}
{% endschema %}
