{{ 'section-hero-b2b-ai.css' | asset_url | stylesheet_tag }}

<div class="hero-b2b">
  <div class="page-width">
    <div
      class="hero-b2b-grid"
      {% if settings.animations_reveal_on_scroll %}
        data-cascade
      {% endif %}
    >
      <div
        class="hero-b2b-content{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
        {% if settings.animations_reveal_on_scroll %}
          style="--animation-order: 1;"
        {% endif %}
      >
        {% if section.settings.kicker != blank %}
          <div class="kicker-brand">{{ section.settings.kicker }}</div>
        {% endif %}

        <h1 class="hero-b2b-title">{{ section.settings.title }}</h1>

        <div class="hero-b2b-text rte">
          {{ section.settings.text }}
        </div>

        <div class="hero-b2b-cta-group">
          {% if section.settings.button_label_1 != blank %}
            <a href="{{ section.settings.button_link_1 }}" class="btn-brand btn-brand-primary">
              {{ section.settings.button_label_1 }}
            </a>
          {% endif %}
          {% if section.settings.button_label_2 != blank %}
            <a href="{{ section.settings.button_link_2 }}" class="btn-brand btn-brand-secondary">
              {{ section.settings.button_label_2 }}
            </a>
          {% endif %}
        </div>
      </div>

      <div
        class="hero-b2b-visual{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
        {% if settings.animations_reveal_on_scroll %}
          style="--animation-order: 2;"
        {% endif %}
      >
        {% assign video_thumbnail = section.settings.video_thumbnail %}
        {% if video_thumbnail == blank and section.settings.video_upload != blank and section.settings.video_upload.preview_image != blank %}
          {% assign video_thumbnail = section.settings.video_upload.preview_image %}
        {% endif %}

        {% assign has_thumbnail = false %}
        {% if video_thumbnail != blank %}
          {% assign has_thumbnail = true %}
        {% endif %}

        {% assign mp4_source_url = '' %}
        {% if section.settings.video_upload != blank %}
          {% assign mp4_sources = section.settings.video_upload.sources | where: 'format', 'mp4' %}
          {% assign mp4_source = mp4_sources | first %}
          {% if mp4_source %}
            {% assign mp4_source_url = mp4_source.url %}
          {% elsif section.settings.video_upload.sources != blank %}
            {% assign fallback_source = section.settings.video_upload.sources | first %}
            {% if fallback_source %}
              {% assign mp4_source_url = fallback_source.url %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% assign has_video_link = false %}
        {% if section.settings.video_url != blank %}
          {% assign has_video_link = true %}
        {% endif %}

        {% assign has_video_content = has_video_link %}
        {% if mp4_source_url != '' %}
          {% assign has_video_content = true %}
        {% endif %}

        {% if has_thumbnail and has_video_content %}
          <div
            class="hero-video-wrapper"
            id="hero-video-trigger-{{ section.id }}"
            role="button"
            aria-label="Play Founder Greeting Video"
            tabindex="0"
            data-video-url="{{ section.settings.video_url | escape }}"
            data-video-upload="{{ mp4_source_url | escape }}"
            data-video-poster="{{ video_thumbnail | image_url: width: 1600 | escape }}"
          >
            <img
              srcset="
                {%- if video_thumbnail.width >= 375 -%}{{ video_thumbnail | image_url: width: 375 }} 375w,{%- endif -%}
                {%- if video_thumbnail.width >= 550 -%}{{ video_thumbnail | image_url: width: 550 }} 550w,{%- endif -%}
                {%- if video_thumbnail.width >= 750 -%}{{ video_thumbnail | image_url: width: 750 }} 750w,{%- endif -%}
                {%- if video_thumbnail.width >= 1100 -%}{{ video_thumbnail | image_url: width: 1100 }} 1100w,{%- endif -%}
              "
              src="{{ video_thumbnail | image_url: width: 800 }}"
              alt="{{ video_thumbnail.alt | default: 'Founder Robert Foster' | escape }}"
              width="{{ video_thumbnail.width }}"
              height="{{ video_thumbnail.height }}"
              class="hero-video-thumbnail"
              loading="eager"
            >
            <div class="hero-video-play-button">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
          </div>
          {% if section.settings.video_caption != blank %}
            <p class="hero-video-caption">{{ section.settings.video_caption }}</p>
          {% endif %}
        {% elsif video_thumbnail == blank %}
          <div class="hero-video-wrapper hero-video-placeholder">
            {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div
  class="hero-video-lightbox"
  id="hero-video-lightbox-{{ section.id }}"
  role="dialog"
  aria-modal="true"
  aria-labelledby="hero-video-title-{{ section.id }}"
>
  <div class="hero-video-lightbox-content">
    <h2 id="hero-video-title-{{ section.id }}" class="visually-hidden">Founder Greeting Video</h2>
    <button class="hero-video-lightbox-close" id="hero-video-close-{{ section.id }}" aria-label="Close video">
      &times;
    </button>
    <div class="hero-video-container"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sectionId = '{{ section.id }}';
    const trigger = document.getElementById('hero-video-trigger-' + sectionId);
    const lightbox = document.getElementById('hero-video-lightbox-' + sectionId);
    const closeBtn = document.getElementById('hero-video-close-' + sectionId);

    // Exit early if elements don't exist (e.g. user didn't configure thumbnail/URL)
    if (!trigger || !lightbox) return;

    const videoContainer = lightbox.querySelector('.hero-video-container');
    const videoUrl = trigger ? trigger.getAttribute('data-video-url') || '' : '';
    const videoUpload = trigger ? trigger.getAttribute('data-video-upload') || '' : '';
    const videoPoster = trigger ? trigger.getAttribute('data-video-poster') || '' : '';

    if (!videoUrl && !videoUpload) return;

    // Function to generate embed URL based on provider
    function getEmbedUrl(url) {
      // Handle YouTube
      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        let videoId = '';
        if (url.includes('v=')) {
          videoId = url.split('v=')[1].split('&')[0];
        } else if (url.includes('youtu.be/')) {
          videoId = url.split('youtu.be/')[1].split('?')[0];
        }
        if (videoId) {
          // Autoplay=1 is crucial for the lightbox experience
          return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
        }
      }

      // Handle Vimeo (using regex for robustness)
      if (url.includes('vimeo.com')) {
        const match = url.match(/vimeo\.com\/(\d+)/);
        if (match && match[1]) {
          return `https://player.vimeo.com/video/${match[1]}?autoplay=1`;
        }
      }

      // Fallback for direct links or already formatted embed URLs
      return url;
    }

    // Function to open lightbox and load video
    function openLightbox() {
      if (videoUpload) {
        const posterAttr = videoPoster ? ` poster="${videoPoster}"` : '';
        videoContainer.innerHTML = `
        <video controls autoplay playsinline${posterAttr}>
          <source src="${videoUpload}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      `;
      } else {
        const embedUrl = getEmbedUrl(videoUrl);
        videoContainer.innerHTML = `
        <iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" allowfullscreen title="Founder Greeting Video"></iframe>
      `;
      }
      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      closeBtn.focus(); // Accessibility: Focus the close button

      if (videoUpload) {
        const inlineVideo = videoContainer.querySelector('video');
        if (inlineVideo && typeof inlineVideo.play === 'function') {
          const playPromise = inlineVideo.play();
          if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch(() => {});
          }
        }
      }
    }

    // Function to close lightbox and stop video
    function closeLightbox() {
      lightbox.style.display = 'none';
      videoContainer.innerHTML = ''; // Stops the video by removing the iframe
      document.body.style.overflow = '';
      trigger.focus(); // Accessibility: Return focus to the trigger
    }

    // Event Listeners
    trigger.addEventListener('click', openLightbox);
    // Handle 'Enter' or 'Space' key press for accessibility
    trigger.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openLightbox();
      }
    });

    closeBtn.addEventListener('click', closeLightbox);

    // Close if clicking outside the video content (on the overlay)
    lightbox.addEventListener('click', function (e) {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Close with ESC key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && lightbox.style.display === 'flex') {
        closeLightbox();
      }
    });
  });
</script>

{% schema %}
{
  "name": "B2B AI Hero",
  "tag": "section",
  "class": "section-hero-b2b-ai",
  "settings": [
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker (Small text above title)",
      "default": "Specialized Consulting for Shopify Plus"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading (H1)",
      "default": "Transforming Shopify DTC Stores into AI-Powered B2B Powerhouses"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Text",
      "default": "<p>Stop struggling with spreadsheets and patchwork solutions. I help established Shopify Plus brands ($1M-$15M GMV) unlock scalable wholesale revenue using the full Shopify B2B suite and strategic AI automation.</p><p><strong>This isn't agency delegation; it's a direct, senior-level partnership with a 10-year Shopify expert.</strong></p>"
    },
    {
      "type": "header",
      "content": "Buttons"
    },
    {
      "type": "text",
      "id": "button_label_1",
      "label": "Primary button label",
      "default": "Book the B2B & AI Roadmap →"
    },
    {
      "type": "url",
      "id": "button_link_1",
      "label": "Primary button link"
    },
    {
      "type": "text",
      "id": "button_label_2",
      "label": "Secondary button label",
      "default": "Request a Personalized Video Audit"
    },
    {
      "type": "url",
      "id": "button_link_2",
      "label": "Secondary button link"
    },
    {
      "type": "header",
      "content": "Founder Video"
    },
    {
      "type": "image_picker",
      "id": "video_thumbnail",
      "label": "Video Thumbnail Image",
      "info": "Upload a high-quality image of the founder. This acts as the portrait and the video placeholder. (Recommended: 16:9 aspect ratio)"
    },
    {
      "type": "video",
      "id": "video_upload",
      "label": "Uploaded video",
      "info": "Upload an MP4 (or MOV) file from your Shopify Files library."
    },
    {
      "type": "url",
      "id": "video_url",
      "label": "Video URL",
      "info": "Paste the URL of the video (e.g., YouTube watch link, Vimeo link). Used if no uploaded video is provided."
    },
    {
      "type": "text",
      "id": "video_caption",
      "label": "Video Caption (Optional)",
      "default": "A Personal Welcome (60s) from Robert Foster"
    }
  ],
  "presets": [
    {
      "name": "B2B AI Hero"
    }
  ]
}
{% endschema %}
